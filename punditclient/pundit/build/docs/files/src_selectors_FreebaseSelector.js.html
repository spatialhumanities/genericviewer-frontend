<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src&#x2F;selectors&#x2F;FreebaseSelector.js - Pundit</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http:&#x2F;&#x2F;thepund.it&#x2F;assets&#x2F;img&#x2F;pundit_500.png" title="Pundit"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: PUNDIT Project 0.12-Pumpkin</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/pundit.annotators.AnnotatorsBase.html">pundit.annotators.AnnotatorsBase</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.AnnotatorsConductor.html">pundit.annotators.AnnotatorsConductor</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.FakeAnnotator.html">pundit.annotators.FakeAnnotator</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.TextFragmentAnnotator.html">pundit.annotators.TextFragmentAnnotator</a></li>
            
                <li><a href="..&#x2F;classes/pundit.authenticatedRequests.html">pundit.authenticatedRequests</a></li>
            
                <li><a href="..&#x2F;classes/pundit.baseComponent.html">pundit.baseComponent</a></li>
            
                <li><a href="..&#x2F;classes/pundit.BasePanel.html">pundit.BasePanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.CommentTag.html">pundit.CommentTag</a></li>
            
                <li><a href="..&#x2F;classes/pundit.CommentTagPanel.html">pundit.CommentTagPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Configuration.html">pundit.Configuration</a></li>
            
                <li><a href="..&#x2F;classes/pundit.contextualMenu.html">pundit.contextualMenu</a></li>
            
                <li><a href="..&#x2F;classes/pundit.DataTxt.html">pundit.DataTxt</a></li>
            
                <li><a href="..&#x2F;classes/pundit.DbpediaSpotlight.html">pundit.DbpediaSpotlight</a></li>
            
                <li><a href="..&#x2F;classes/pundit.FastTextHandler.html">pundit.FastTextHandler</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ImageAnnotationPanel.html">pundit.ImageAnnotationPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Init.html">pundit.Init</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ItemContainerManager.html">pundit.ItemContainerManager</a></li>
            
                <li><a href="..&#x2F;classes/pundit.KorboBasketSelector.html">pundit.KorboBasketSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.myPundit.html">pundit.myPundit</a></li>
            
                <li><a href="..&#x2F;classes/pundit.NotebookManager.html">pundit.NotebookManager</a></li>
            
                <li><a href="..&#x2F;classes/pundit.PageHandler.html">pundit.PageHandler</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Previewer.html">pundit.Previewer</a></li>
            
                <li><a href="..&#x2F;classes/pundit.RecognizerPanel.html">pundit.RecognizerPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ResourcesPanel.html">pundit.ResourcesPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.BibServerSelector.html">pundit.selectors.BibServerSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.DBPediaSelector.html">pundit.selectors.DBPediaSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.EuropeanaSelector.html">pundit.selectors.EuropeanaSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.FreebaseSelector.html">pundit.selectors.FreebaseSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.SelectorBase.html">pundit.selectors.SelectorBase</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.VocabSelector.html">pundit.selectors.VocabSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.WordnetSelector.html">pundit.selectors.WordnetSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.TripleComposer.html">pundit.TripleComposer</a></li>
            
                <li><a href="..&#x2F;classes/pundit.XpointersHelper.html">pundit.XpointersHelper</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/pundit.html">pundit</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src&#x2F;selectors&#x2F;FreebaseSelector.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
  * @class pundit.selectors.FreebaseSelector
  * @extends pundit.selectors.SelectorBase
  * @description 
  * TODO TODO TODO TODO 
  *&#x2F;
dojo.provide(&quot;pundit.selectors.FreebaseSelector&quot;);
dojo.declare(&quot;pundit.selectors.FreebaseSelector&quot;, pundit.selectors.SelectorBase, {

    opts: {
        &#x2F;&#x2F; Number of items to display in the suggestion list
        limit: 30,

        &#x2F;&#x2F; Ms to wait after a keystroke before querying the service
        keyInputTimerLength: 500,
        keywordMinimumLength: 3,
        
        freebaseReconURL: &#x27;http:&#x2F;&#x2F;data.labs.freebase.com&#x2F;recon&#x2F;query&#x27;,
        freebaseSchemaBaseURL: &#x27;http:&#x2F;&#x2F;www.freebase.com&#x2F;schema&#x27;,
        freebaseImagesBaseURL: &#x27;http:&#x2F;&#x2F;api.freebase.com&#x2F;api&#x2F;trans&#x2F;image_thumb&#x27;,
        freebaseMQLReadURL: &#x27;https:&#x2F;&#x2F;api.freebase.com&#x2F;api&#x2F;service&#x2F;mqlread&#x27;,
        freebaseBlurbURL: &#x27;http:&#x2F;&#x2F;api.freebase.com&#x2F;api&#x2F;trans&#x2F;blurb&#x2F;guid&#x2F;&#x27;,
        freebaseItemsBaseURL: &#x27;http:&#x2F;&#x2F;rdf.freebase.com&#x2F;ns&#x2F;&#x27;,

        &#x2F;&#x2F; Artificial timeout for atypical 404 freebase answers
        blurbTimeoutMS: 5000,
        
        &#x2F;&#x2F; TODO: let the user configure the freebase query somehow? 
        
        layouts: [&#x27;list&#x27;, &#x27;tile&#x27;]
    },

    constructor: function(options) {
        var self = this;
        
        self.requests = {};
        self.log(&#x27;Selector &#x27;+self.name+&#x27; up and running.&#x27;);
    }, &#x2F;&#x2F; constructor()
    
    &#x2F;&#x2F; (async) Return a list of items for the given term, calling the callback func
    getItemsForTerm: function(term, func, errorFunc) {
        var self = this;
        
        &#x2F;&#x2F; TODO: cache the results? 
        self.requests[term] = {
            f: func, 
            items: [], 
            done: 0,
            blurbTimers: {}
        };
        
        &#x2F;&#x2F; Add function for error
        if (typeof(errorFunc) !== &#x27;undefined&#x27;)
            self.requests[term].ef = errorFunc;
        
        self.requests[term].jobId = _PUNDIT.loadingBox.addJob(&#x27;Freebase query: &#x27;+term);

        dojo.io.script.get({
            callbackParamName: &quot;jsonp&quot;,
            url: self.opts.freebaseReconURL,
            content: {
                q: dojo.toJson({ &quot;&#x2F;type&#x2F;object&#x2F;name&quot;: term}),
                limit: self.opts.limit
            },
            load: function(r) {
                self.requests[term].len = r.length;
                if (r.length === 0) {
                    _PUNDIT.loadingBox.setJobOk(self.requests[term].jobId);
                    self._itemRequestDone(term);
                } else {
                    self._getItemsFromFreebaseResults(r, term);
                }
            },
            error: function(response, ioArgs) {
                self.log(self.name+&#x27; getItemsForTerm got an error :(&#x27;);
                &#x2F;&#x2F; TODO: what to do with passed function??
                if (typeof self.requests[term].ef !== &#x27;undefined&#x27;)
                    self.requests[term].ef();
                func([]);
                _PUNDIT.loadingBox.setJobKo(req.jobId);
            }
        });
        
    }, &#x2F;&#x2F; getItemsForTerm()
    
    _getItemsFromFreebaseResults: function (r, term) {
        var self = this, 
            len = r.length,
            result = [];
            
        &#x2F;&#x2F; Request has been canceled    
        if (typeof(self.requests[term]) === &#x27;undefined&#x27;)
            return;
        
        for (var i=0; i&lt;len; i++) {

            var rdf_types = [], 
                item;
            
            for (var j = r[i].type.length; j--;)
                rdf_types.push(self.opts.freebaseSchemaBaseURL + r[i].type[j])

            item = {
                type: [&#x27;subject&#x27;],
                rdftype: rdf_types,
                label: r[i].name[0], 
                value: r[i].id.replace(&quot;&#x2F;guid&#x2F;&quot;, &quot;&quot;),
                description: &#x27;&#x27;,
                desc_types: r[i].type,
                desc_guid: r[i].id.replace(&quot;&#x2F;guid&#x2F;&quot;, &quot;&quot;),
                altLabel: r[i].name.join(&#x27;, &#x27;),
                image: self.opts.freebaseImagesBaseURL + r[i].id
            };

            self.requests[term].items.push(item);
            self._getItemDescription(item, term);
        };

        return result;
        
    }, &#x2F;&#x2F; _getItemsFromFreebaseResults(r, func)
    
    _getItemDescription: function(item, term) {
        var self = this;
        
        dojo.io.script.get({
            callbackParamName: &quot;callback&quot;,
            url: self.opts.freebaseMQLReadURL,
            content: {
                query : dojo.toJson({
                    &#x27;query&#x27;: { 
                        &quot;guid&quot;: &#x27;#&#x27;+ item.desc_guid,
                        &quot;id&quot;: null,
                        &quot;mid&quot;: null ,
                        &quot;name&quot;: null
                    }
                }),
                limit: self.opts.limit 
            },
            load: function(r) {
                item.value = self.opts.freebaseItemsBaseURL + r.result.id.substring(1).replace(&#x2F;\&#x2F;&#x2F;g,&#x27;.&#x27;);

                &#x2F;&#x2F; Description is not &#x27;&#x27;: this call is the last one, we&#x27;re done
                if (item.description !== &#x27;&#x27;) {
                    item.rdfData = semlibItems.createBucketForItem(item).bucket;
                    self._itemRequestDone(term);
                }
            }
        }); &#x2F;&#x2F; dojo.io.script.get()

        &#x2F;&#x2F; Freebase allows an onfail guid to display in case the requested one
        &#x2F;&#x2F; doesnt have a blurb. Instead of a 404, it sends a Location Header.
        &#x2F;&#x2F; Redirect it and supply a callback to be called.
        dojo.io.script.get({
            callbackParamName: &quot;callback&quot;,
            url: self.opts.freebaseBlurbURL + item.desc_guid,
            content: {onfail: &#x27;9202a8c04000641f8000000000e6bc61?callback=_notfound&#x27;+item.desc_guid},
            failOk: false,
            load: function(r) { 
                clearTimeout(self.requests[term].blurbTimers[item.desc_guid]);
                item.description = r.result.body;

                &#x2F;&#x2F; Value != desc_guid: this call is the last one, we&#x27;re done
                if (item.value !== item.desc_guid) {
                    item.rdfData = semlibItems.createBucketForItem(item).bucket;
                    self._itemRequestDone(term);
                }
            },
            error: function(e) {
                clearTimeout(self.requests[term].blurbTimers[item.desc_guid]);
                item.description = item.label;

                &#x2F;&#x2F; Value != desc_guid: this call is the last one, we&#x27;re done
                if (item.value !== item.desc_guid) {
                    item.rdfData = semlibItems.createBucketForItem(item).bucket;
                    self._itemRequestDone(term);
                }
                return false;
            }

        });

        &#x2F;&#x2F; If this gets called, no description was found
        window[&#x27;_notfound&#x27;+item.desc_guid] = function() {
            clearTimeout(self.requests[term].blurbTimers[item.desc_guid]);
            item.description = item.label;
            &#x2F;&#x2F; Value != desc_guid: this call is the last one, we&#x27;re done
            if (item.value !== item.desc_guid) {
                item.rdfData = semlibItems.createBucketForItem(item).bucket;
                self._itemRequestDone(term);
            }
        };
        
        &#x2F;&#x2F; Bizarre case: some guid returns a different 404, not the one we&#x27;re
        &#x2F;&#x2F; handling with the onfail parameter
        &#x2F;&#x2F; (eg: http:&#x2F;&#x2F;api.freebase.com&#x2F;api&#x2F;trans&#x2F;blurb&#x2F;guid&#x2F;9202a8c04000641f800000000ab11253)
        self.requests[term].blurbTimers[item.desc_guid] = setTimeout(function() {
            self.log(&#x27;Atypical 404 timed out for guid &#x27; + item.desc_guid);
            window[&#x27;_notfound&#x27;+item.desc_guid]();
        }, self.opts.blurbTimeoutMS)
        
    }, &#x2F;&#x2F; _getItemDescription()
    
    _itemRequestDone: function(term) {
        var self = this,
            req = self.requests[term];
        
        &#x2F;&#x2F; Request has been canceled
        if (typeof(req.canceled) !== &#x27;undefined&#x27;)
            return;

        req.done += 1;
        self.log(&#x27;Query: &#x27;+term+&#x27;, done: &#x27;+req.done+&#x27;&#x2F;&#x27;+req.len);

        if (req.done &lt; req.len)
            return;

        self.log(&#x27;Done loading items for term &#x27;+term+&#x27;.. calling the function.&#x27;);
        req.f(req.items,term);

        _PUNDIT.loadingBox.setJobOk(req.jobId);

    },
    
    cancelRequests: function(){
        var self = this,
            reqs = self.requests;
        
        for (var i in reqs) {
            reqs[i].len = 0;
            self._itemRequestDone(i);
            reqs[i].canceled = true;
        }
    }

});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
