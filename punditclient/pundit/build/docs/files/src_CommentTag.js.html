<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src&#x2F;CommentTag.js - Pundit</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http:&#x2F;&#x2F;thepund.it&#x2F;assets&#x2F;img&#x2F;pundit_500.png" title="Pundit"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: PUNDIT Project 0.12-Pumpkin</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/pundit.annotators.AnnotatorsBase.html">pundit.annotators.AnnotatorsBase</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.AnnotatorsConductor.html">pundit.annotators.AnnotatorsConductor</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.FakeAnnotator.html">pundit.annotators.FakeAnnotator</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.TextFragmentAnnotator.html">pundit.annotators.TextFragmentAnnotator</a></li>
            
                <li><a href="..&#x2F;classes/pundit.authenticatedRequests.html">pundit.authenticatedRequests</a></li>
            
                <li><a href="..&#x2F;classes/pundit.baseComponent.html">pundit.baseComponent</a></li>
            
                <li><a href="..&#x2F;classes/pundit.BasePanel.html">pundit.BasePanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.CommentTag.html">pundit.CommentTag</a></li>
            
                <li><a href="..&#x2F;classes/pundit.CommentTagPanel.html">pundit.CommentTagPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Configuration.html">pundit.Configuration</a></li>
            
                <li><a href="..&#x2F;classes/pundit.contextualMenu.html">pundit.contextualMenu</a></li>
            
                <li><a href="..&#x2F;classes/pundit.DataTxt.html">pundit.DataTxt</a></li>
            
                <li><a href="..&#x2F;classes/pundit.DbpediaSpotlight.html">pundit.DbpediaSpotlight</a></li>
            
                <li><a href="..&#x2F;classes/pundit.FastTextHandler.html">pundit.FastTextHandler</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ImageAnnotationPanel.html">pundit.ImageAnnotationPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Init.html">pundit.Init</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ItemContainerManager.html">pundit.ItemContainerManager</a></li>
            
                <li><a href="..&#x2F;classes/pundit.KorboBasketSelector.html">pundit.KorboBasketSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.myPundit.html">pundit.myPundit</a></li>
            
                <li><a href="..&#x2F;classes/pundit.NotebookManager.html">pundit.NotebookManager</a></li>
            
                <li><a href="..&#x2F;classes/pundit.PageHandler.html">pundit.PageHandler</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Previewer.html">pundit.Previewer</a></li>
            
                <li><a href="..&#x2F;classes/pundit.RecognizerPanel.html">pundit.RecognizerPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ResourcesPanel.html">pundit.ResourcesPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.BibServerSelector.html">pundit.selectors.BibServerSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.DBPediaSelector.html">pundit.selectors.DBPediaSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.EuropeanaSelector.html">pundit.selectors.EuropeanaSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.FreebaseSelector.html">pundit.selectors.FreebaseSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.SelectorBase.html">pundit.selectors.SelectorBase</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.VocabSelector.html">pundit.selectors.VocabSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.WordnetSelector.html">pundit.selectors.WordnetSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.TripleComposer.html">pundit.TripleComposer</a></li>
            
                <li><a href="..&#x2F;classes/pundit.XpointersHelper.html">pundit.XpointersHelper</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/pundit.html">pundit</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src&#x2F;CommentTag.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
 * @class pundit.CommentTag
 * @extends pundit.baseComponent
 * @description Provides a GUI (floating Panel) and set of facilities 
 * for the creation of comments and tags. Tags can be retrieved both using 
 * DBpedia Spotlight (annotating the text comment). Tags can be removed and navigated
 * Created comments and tags are then saved to pundit annotation server
 *&#x2F;
dojo.provide(&quot;pundit.CommentTag&quot;);
dojo.declare(&quot;pundit.CommentTag&quot;, pundit.BaseComponent, {

    constructor: function(options) {
        var self = this;
        
        &#x2F;&#x2F;Annotation target
        &#x2F;&#x2F; DEBUG: x marco quando accade che abbiamo piu&#x27; targets?
        self.targets = [];
        self.targType; &#x2F;&#x2F;target type could be not only a text fragment but also an image
        self.xpTarget = &quot;&quot;;
        
        self.saved = false;
        
        self.tagItems = [];
        self.enableSemanticExpansion;
        self.lastTagInfoRequests = [];
        self.lastTagRequest;
        self.lastSearchedComment = &#x27;&#x27;;
        self.tagListItemSelected = false;
        
        semlibDbpediaSpotlight.onGetTagsFromSpotlight(function(tags){
            self.showMarkedText(tags);
            self.addSuggestedTags(tags);
            if (tags.length === 0)
                dojo.query(&#x27;#pundit-ctp-tags&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
        });
        
        semlibDbpediaSpotlight.onGetInfoFromDBpedia(function(info){
            self.addTagInfo(info);

            var data = self.tagItems[self.itemIndex(info.uri)];
            var item = {};
            item.data = data;
            item.data.type = [&#x27;subject&#x27;];
            item.data.value = data.uri;
            item.data.suggested = true;
            item.value = data.uri;
            item.data.rdfData = semlibItems.createBucketForVocabItem(item.data).bucket;
            &#x2F;&#x2F;self.tagsDnD.insertNodes(false, [item.data]);
            self.addItems([item.data]);
            previewer.buildPreviewForItem(item.data);

            if (info.uri === dojo.query(&#x27;#pundit-ctp-tag-list li.pundit-selected&#x27;).attr(&#x27;about&#x27;)[0]){
                &#x2F;&#x2F;Update preview

                var item = self.tagItems[self.itemIndex(info.uri)],
                    img = &#x27;&#x27;;
                if (typeof(item.image) !== &#x27;undefined&#x27;)
                    img = &#x27;&lt;img src=&quot;&#x27; + item.image + &#x27;&quot;&gt;&lt;&#x2F;img&gt;&#x27;;

                var html = &#x27;&lt;span&gt;&#x27; + img + item.description + &#x27;&lt;&#x2F;span&gt;&#x27;;
                dojo.html.set(&#x27;pundit-ctp-tag-preview&#x27;, html);
                dojo.query(&#x27;#pundit-ctp-tag-preview&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
            }
            
            var r = self.lastTagInfoRequests;
            for (var i in r){
                if (r[i].ioArgs.args.id === item.data.value)
                    self.lastTagInfoRequests.splice(i,1);
                break;
            } 
            &#x2F;&#x2F;remove request from queue
            
            dojo.query(&#x27;#pundit-ctp-tags&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
            self.updateSaveBtn();
            dojo.behavior.apply();
        });
        
        semlibDbpediaSpotlight.onError(function(){
            dojo.query(&#x27;#pundit-ctp-tags&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
        });
            
        self.saver = new pundit.AnnotationWriter({debug: self.opts.debug});
            
        self.saver.onSaveItems(function(annotationID) {
            self.log(&#x27;onSaveItems: Saver answered with &#x27;+ annotationID);
            self.saved = true;
            self.close();
        });
        self.saver.onSave(function(m){
            self.log(&#x27;onSave: Saver answered with &#x27;+m);
            self.saveItems(m);
        });
        
        
        semlibDbpediaSpotlight.onTextLookup(function(d){
            if (d.length &gt;0) {
                self.itemsDnD.selectAll();
                self.itemsDnD.deleteSelectedNodes();
                &#x2F;&#x2F;dojo.empty(&#x27;reconItems&#x27;);
                for (var i in d){
                    var item = {};
                    item.data = d[i];
                    item.data.type = [&#x27;subject&#x27;];
                    item.value = d[i].value;
                    item.data.rdfData = semlibItems.createBucketForVocabItem(item.data).bucket;
                    previewer.buildPreviewForItem(item.data);
                    self.itemsDnD.insertNodes(false, [item.data]);
                }
            }
            dojo.query(&#x27;#pundit-ctp-more-tags&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
            dojo.behavior.apply();
        });
        semlibDbpediaSpotlight.onLookupError(function(){
            dojo.query(&#x27;#pundit-ctp-more-tags&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
            dojo.empty(&#x27;pundit-ctp-more-tags&#x27;);            
            dojo.query(&#x27;#pundit-ctp-more-tags&#x27;).append(&#x27;&lt;li class=&quot;pundit-shown pundit-lookup-error&quot;&gt;DBPedia Lookup Service has not responded.&lt;&#x2F;li&gt;&#x27;);
        });
        
        dojo.subscribe(&quot;&#x2F;dnd&#x2F;drop&quot;, function(source, nodes, copy, target) {
            if (source === self.itemsDnD){
                &#x2F;&#x2F;DEBUG Simone: If called as soon as the item is dropped item 
                &#x2F;&#x2F;has not been added yet and the update fails. Any hint?
                setTimeout(function(){self.updateSaveBtn();},100);
            }
        });

        self.initContextMenu();

        &#x2F;&#x2F; On consolidate: if we are opening the dialog highlight the xpointer
        _PUNDIT.init.onInitDone(function() {
            tooltip_viewer.onConsolidate(function() {
                if (self.opening) {
                    self.opening = false;
                    tooltip_viewer.highlightByXpointer(self.xpTarget);
                }
            });
        });
        self.log(&#x27;Comment Tag up and running&#x27;);

    }, &#x2F;&#x2F; constructor()

    initDialog: function(targs, targType){
        var self = this;
        
        
        if (typeof targType === &#x27;undefined&#x27;)
            targType = ns.fragments.text;
        
        self.targType = targType;
        self.xpTarget = targs;

        &#x2F;&#x2F; DEBUG: quando accade che chiami la initDialog senza target?
        &#x2F;&#x2F; TO SIMONE Not now but I was thinking of adding comment to a page
        &#x2F;*
        if (typeof(targs) === &#x27;undefined&#x27;){
            &#x2F;&#x2F; if no target specified target is the page
            self.xpTarget = (window.location.href);
        } else {
            if (typeof(targs) === &#x27;string&#x27;)
                self.targets.push(targs);
            else
                self.targets = targs;
        }
        *&#x2F;
        self.targets.push(targs);

        &#x2F;&#x2F; If it&#x27;s a myItem or a pageItem, highlight it now. 
        &#x2F;&#x2F; If the xpTarget is not consolidated yet, the onConsolidate callback
        &#x2F;&#x2F; will highlight it
        self.opening = true;
        if (semlibMyItems.uriInItems(self.xpTarget) || semlibItems.uriInItems(self.xpTarget))
            tooltip_viewer.highlightByXpointer(self.xpTarget);


        var c =  &#x27;&lt;div id=&quot;pundit-ctp&quot; class=&quot;pundit-base pundit-floating-panel pundit-disable-annotation pundit-stop-wheel-propagation&quot;&gt;&#x27;;
        c += &#x27;  &lt;div id=&quot;pundit-ctp-header&quot; class=&quot;pundit-floating-panel-header&quot;&gt;&lt;span class=&quot;pundit-ctp-title&quot;&gt;Comment&#x2F;Tag&lt;&#x2F;span&gt;&lt;span id=&quot;pundit-ctp-close&quot; class=&quot;pundit-icon-close&quot;&gt;&lt;&#x2F;span&gt;&lt;&#x2F;div&gt;&#x27;;
        c += &#x27;  &lt;ul id=&quot;pundit-ctp-content-list&quot; class=&quot;pundit-horizontal-list&quot;&gt;&#x27;;
        c += &#x27;      &lt;li&gt;&#x27;;
        c += &#x27;              &lt;div id=&quot;pundit-ctp-comment-container&quot; class=&quot;pundit-floating-panel-container&quot;&gt;&#x27;;
        c += &#x27;				   &lt;div class=&quot;pundit-container-header&quot;&gt;&#x27;;
        c += &#x27;                 		&lt;span class=&quot;pundit-ctp-title&quot; &gt;Comment:&lt;&#x2F;span&gt;&#x27;;
        c += &#x27;						&lt;button id=&quot;pundit-ctp-extract-tags&quot; style=&quot;float:right&quot;&gt;Extract Tags&lt;&#x2F;button&gt;&#x27;;
        c += &#x27;				   &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;                 &lt;div class=&quot;pundit-ctp-comment-input&quot;&gt;&#x27;;
        c += &#x27;                      &lt;section contenteditable=&quot;true&quot; id=&quot;pundit-ctp-comment-input&quot; class=&quot;pundit-stop-wheel-propagation&quot;&gt;&lt;&#x2F;section&gt;&#x27;;
        c += &#x27;                  &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;              &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;              &lt;div id=&quot;pundit-ctp-tags-container&quot; class=&quot;pundit-floating-panel-container&quot; style=&quot;width:300px;margin-top:5px&quot;&gt;&#x27;;
        c += &#x27;                  &lt;div id=&quot;pundit-ctp-tags&quot;&gt;&#x27;;
        c += &#x27;                      &lt;span class=&quot;pundit-ctp-title&quot;&gt;Tags&lt;&#x2F;span&gt;&#x27;;
        c += &#x27;                      &lt;ul id=&quot;pundit-ctp-tag-list&quot; class=&quot;pundit-items pundit-view-list showsRemoveButton pundit-stop-wheel-propagation&quot;&gt;&lt;&#x2F;ul&gt;&#x27;;
        c += &#x27;                  &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;              &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;              &lt;div id=&quot;pundit-ctp-more-tags-container&quot; class=&quot;pundit-floating-panel-container&quot;&gt;&#x27;;
        c += &#x27;                  &lt;div id=&quot;pundit-ctp-tag-search&quot; class=&quot;pundit-stop-wheel-propagation&quot;&gt;&#x27;;
        c += &#x27;                      &lt;span class=&quot;pundit-ctp-title&quot;&gt;Add More Tags:&lt;&#x2F;span&gt;&#x27;;
        c += &#x27;                      &lt;input id=&quot;pundit-ctp-more-tags-input&quot; row=&quot;1&quot; placeholder=&quot;.. type here!&quot; class=&quot;pundit-dialog-input pundit-stop-wheel-propagation&quot;&#x2F;&gt;&#x27;;
        c += &#x27;					&lt;&#x2F;div&gt;&#x27;;
        c += &#x27;                  &lt;div id=&quot;pundit-ctp-suggestion-container&quot; class=&quot;pundit-stop-wheel-propagation&quot;&gt;&#x27;;
        c += &#x27;                      &lt;span class=&quot;pundit-ctp-title&quot;&gt;Suggestions:&lt;&#x2F;span&gt;&#x27;;
        c += &#x27;                  &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;                  &lt;div id=&quot;pundit-ctp-more-tags&quot;&gt;&#x27;;
        c += &#x27;                      &lt;ul id=&quot;pundit-ctp-more-tags-list&quot; class=&quot;pundit-ctp-more-tags-list pundit-items pundit-view-list pundit-item-add-button pundit-stop-wheel-propagation&quot;&gt;&lt;&#x2F;ul&gt;&#x27;;
        c += &#x27;                  &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;              &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;              &lt;button id=&quot;pundit-ctp-save&quot; class=&quot;pundit-button-disabled&quot;&gt;Save&lt;&#x2F;button&gt;&#x27;;
        c += &#x27;      &lt;&#x2F;li&gt;&#x27;;
        c += &#x27;      &lt;li id=&quot;pundit-ctp-preview&quot;&gt;&#x27;;
        c += &#x27;          &lt;div class=&quot;pundit-floating-panel-container fillheight&quot;&gt;&#x27;;
        c += &#x27;              &lt;div id=&quot;pundit-ctp-tag-preview&quot; class=&quot;pundit-moreinfo-panel pundit-stop-wheel-propagation fillheight&quot;&gt;&lt;&#x2F;div&gt;&#x27;;
        c += &#x27;          &lt;&#x2F;div&gt;&#x27;;
        c += &#x27;      &lt;&#x2F;li&gt;&#x27;;
        c += &#x27;  &lt;&#x2F;ul&gt;&#x27;
        c += &#x27;&lt;&#x2F;div&gt;&#x27;

        if (dojo.exists(&#x27;pundit-ctp&#x27;)){
            self.cancelPendingRequests();
            dojo.destroy(dojo.byId(&#x27;pundit-ctp&#x27;));
        }
            
        dojo.query(&#x27;body&#x27;).append(&#x27;&lt;div id=&quot;pundit-ctp-container&quot;&gt;&lt;&#x2F;div&#x27;);
        dojo.query(&#x27;body&#x27;).append(c);
            
        dojo.attr(dojo.byId(&quot;pundit-ctp-save&quot;), &#x27;disabled&#x27;, true);
        dojo.attr(dojo.byId(&quot;pundit-ctp-extract-tags&quot;), &#x27;disabled&#x27;, true);
            
        this.initBehaviors();
        
        &#x2F;&#x2F; semlibItems source does not accept any item; 
        &#x2F;&#x2F; dnd drag actions copy items from it
        self.itemsDnD = new dojo.dnd.Source(&quot;pundit-ctp-more-tags-list&quot;, {
            copyOnly: false, 
            creator: semlibItems.itemNodeCreator,
            checkAcceptance: function() {
                return false;
            }
        });
        self.tagsDnD = new dojo.dnd.Target(&#x27;pundit-ctp-tag-list&#x27;,{
            copyOnly: true,
            creator: semlibItems.itemNodeCreator,
            checkAcceptance: function(source, nodes) {
                &#x2F;&#x2F;Accept only drag from suggested tags
                if (source === self.itemsDnD){
                    for (var i in nodes){
                        if (self.uriInItems(source.getItem(nodes[i].id).data.value))
                            return false;
                        else
                            return true;
                    }
                    return true;
                }
                else{
                    return false;
                }
            }
        });
        setTimeout(function(){
            self.show();
        },100); 
    },

    initContextMenu: function(){
        var self = this;

        &#x2F;&#x2F; Text and selected fragments: add comments&#x2F;tags action
        cMenu.addAction({
            type: [&#x27;annotatedtextfragment&#x27;, &#x27;bookmarkedtextfragment&#x27;],
            name: &#x27;AddCommentTagToAnnotatedFragment&#x27;,
            label: &#x27;Comment or tag&#x27;,
            showIf: function() { 
                return true;
            },
            onclick: function(xp) {
				var item = _PUNDIT.items.getItemByUri(xp);
                &#x2F;&#x2F;var item = fragmentHandler.createItemFromXpointer(xp);

                if (!semlibItems.uriInItems(item.value)) {
                    semlibItems.addItem(item);
                    previewer.buildPreviewForItem(item);
                }

                if (!tooltip_viewer.isTempXpointer(xp)){
                    tooltip_viewer.tempXpointers.push(xp);
                    &#x2F;&#x2F; tooltip_viewer.refreshAnnotations();
                    &#x2F;&#x2F; DEBUG: not sure we can avoid the refreshAnnotations() process
                    tooltip_viewer.consolidate();
                }
                self.initDialog(xp);
                return true;
            }
        });
        
        &#x2F;&#x2F; Freshly selected portion of text: add comments&#x2F;tags action
        cMenu.addAction({
            type: [&#x27;textSelectionHelper&#x27;],
            name: &#x27;AddCommentTagToText&#x27;,
            label: &#x27;Comment or tag&#x27;,
            showIf: function() { 
                return true;
            },
            onclick: function(xp) {
                
                &#x2F;&#x2F;TODO Currently I need this for a problem related to createItemFromXpointer
                &#x2F;&#x2F;Remove item creation once it will have been solved
                var item = fragmentHandler.createItemFromXpointer(xp);

                if (!semlibItems.uriInItems(item.value)) {
                    semlibItems.addItem(item);
                    previewer.buildPreviewForItem(item);
                }
                
                if (!tooltip_viewer.isTempXpointer(xp)){
                    tooltip_viewer.tempXpointers.push(xp);
                    &#x2F;&#x2F; tooltip_viewer.refreshAnnotations();
                    &#x2F;&#x2F; DEBUG: not sure we can avoid the refreshAnnotations() process
                    tooltip_viewer.consolidate();
                }
                
                self.initDialog(xp);
                return true;
            }
        });
        
        cMenu.addAction({
            type: [&#x27;tagitem&#x27;],
            name: &#x27;removeTagItem&#x27;,
            label: &#x27;Remove this item&#x27;,
            showIf: function(uri) {
                return true;
            },
            onclick: function(uri) {
                return self.removeTagItem(uri);
            }
        });

        &#x2F;&#x2F; pundititem: open its webpage if item is not a textfragment
        cMenu.addAction({
            type: [&#x27;tagitem&#x27;],
            name: &#x27;openTagWebPage&#x27;,
            label: &#x27;Open Web Page&#x27;,
            showIf: function(uri) {
                return true;
            },
            onclick: function(uri) {
                window.open(uri, &#x27;SemLibOpenedWebPage&#x27;);
                return true;
            }
        });
    
        cMenu.addAction({
            type: [&#x27;suggestedtagitem&#x27;],
            name: &#x27;insertSuggestedTagItem&#x27;,
            label: &#x27;Add tag&#x27;,
            showIf: function(uri) {
                return true;
            },
            onclick: function(uri) {
                return self.addTagItem(uri);
            }
        });

        &#x2F;&#x2F; pundititem: open its webpage if item is not a textfragment
        cMenu.addAction({
            type: [&#x27;suggestedtagitem&#x27;],
            name: &#x27;openSuggestedTagWebPage&#x27;,
            label: &#x27;Open Web Page&#x27;,
            showIf: function(uri) {
                return true;
            },
            onclick: function(uri) {
                window.open(uri, &#x27;SemLibOpenedWebPage&#x27;);
                return true;
            }
        });
    },

    initBehaviors:function(){
        var self = this;
        
        dojo.connect(dojo.byId(&#x27;pundit-ctp-extract-tags&#x27;), &#x27;onclick&#x27;, function (evt) {
            &#x2F;&#x2F;var comment = dojo.byId(&#x27;pundit-ctp-comment-input&#x27;).value;
            var tags = [];
            &#x2F;&#x2F;Remove spotlight tags if any
            var comment = unescape(dojo.byId(&#x27;pundit-ctp-comment-input&#x27;).innerHTML.replace(&#x2F;&lt;(?:.|\n)*?&gt;&#x2F;gm, &#x27;&#x27;).replace(&#x2F;&amp;nbsp;&#x2F;g, &#x27; &#x27;));
            if (comment !== &quot;&quot;) {
                
                self.cancelPendingSpotlightRequests();
                
                self.tagsDnD.selectNone();
                dojo.query(&#x27;#pundit-ctp-tag-list li.dojoDndItem&#x27;).forEach(function(tag){
                    if (typeof(self.tagsDnD.map[tag.id].data.suggested) !== &#x27;undefined&#x27;){
                            self.tagsDnD.selection[tag.id] = 1;
                            self.removeItemFromUri(self.tagsDnD.map[tag.id].data.value);
                    }
                });
                self.tagsDnD.deleteSelectedNodes();
                
                &#x2F;&#x2F;TODO Should I also delete tags from array
                &#x2F;&#x2F;Do I use the array?
                
                
                &#x2F;&#x2F;Remove tags
                
                if (self.tagListItemSelected) {
                    &#x2F;&#x2F;previewer.deselectCurrentSelectedItem(&#x27;#pundit-ctp-tag-preview&#x27;);
                    self.tagListItemSelected = false;
                }
                
                dojo.query(&#x27;#pundit-ctp-tags&#x27;).addClass(&#x27;pundit-panel-loading&#x27;);
                self.enableSemanticExpansion = semlibDbpediaSpotlight.getEntities(comment);
                self.lastSearchedComment = comment;
                dojo.query(&#x27;#pundit-ctp-extract-tags&#x27;).attr(&#x27;disabled&#x27;, true);
                self.tagItems = [];
                self.updateSaveBtn();
            }
        });
        
        dojo.connect(dojo.byId(&#x27;pundit-ctp-comment-input&#x27;), &#x27;paste&#x27;, function(e){
            &#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;
            &#x2F;&#x2F;Try to intercet tag
        });
        
        &#x2F;&#x2F;DRAG &#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;
        dojo.connect(dojo.byId(&#x27;pundit-ctp-header&#x27;), &#x27;onmousedown&#x27;, function (e){
           dojo.stopEvent(e);
           self.moving = true;
           self.start = {
               left : dojo.style(&#x27;pundit-ctp&#x27;, &#x27;left&#x27;),
               top : dojo.style(&#x27;pundit-ctp&#x27;, &#x27;top&#x27;),
               x: e.pageX,
               y: e.pageY
           };
           
        });
        
        dojo.connect(window, &#x27;onmousemove&#x27;, function(e){
           if (self.moving === true){
               dojo.stopEvent(e);
               dojo.style(&#x27;pundit-ctp&#x27;, &#x27;left&#x27;, self.start.left - self.start.x + e.pageX + &#x27;px&#x27;);
               dojo.style(&#x27;pundit-ctp&#x27;, &#x27;top&#x27;, self.start.top - self.start.y + e.pageY + &#x27;px&#x27;);
           }
        });
        &#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;END DRAG&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;
        
        dojo.connect(window, &#x27;onmouseup&#x27;, function(e){
           self.moving = false;
        });
        
        dojo.connect(dojo.byId(&#x27;pundit-ctp-close&#x27;), &#x27;onclick&#x27;, function(){
           &#x2F;&#x2F;Add animation for making it deseappear
           self.close();
        });

        dojo.connect(dojo.byId(&#x27;pundit-ctp-comment-input&#x27;), &#x27;onkeydown&#x27;, function (evt) {
            dojo.query(&#x27;#pundit-ctp-extract-tags&#x27;).attr(&#x27;disabled&#x27;, false);
        });
        dojo.connect(dojo.byId(&quot;pundit-ctp-comment-input&quot;),&#x27;onclick&#x27;, function(){
            self.cancelPendingSpotlightRequests();
            dojo.query(&#x27;#pundit-ctp-tags&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
            dojo.attr(dojo.byId(&quot;pundit-ctp-extract-tags&quot;), &#x27;disabled&#x27;, false);
            
        });
        dojo.connect(dojo.byId(&quot;pundit-ctp-comment-input&quot;),&#x27;onkeyup&#x27;, function(){
            if ((dojo.byId(&#x27;pundit-ctp-comment-input&#x27;).innerHTML.replace(&#x2F;&lt;(?:.|\n)*?&gt;&#x2F;gm, &#x27;&#x27;) === &#x27;&#x27;))
                dojo.attr(dojo.byId(&quot;pundit-ctp-extract-tags&quot;), &#x27;disabled&#x27;, true);
            else
                dojo.attr(dojo.byId(&quot;pundit-ctp-extract-tags&quot;), &#x27;disabled&#x27;, false);
            self.updateSaveBtn();
        });

        dojo.connect(dojo.byId(&#x27;pundit-ctp-save&#x27;), &#x27;onclick&#x27;, function (evt) {
            self.saveTriples();
        });
        
        dojo.connect(dojo.query(&#x27;#pundit-ctp-more-tags-input&#x27;)[0], &#x27;onkeyup&#x27;, function(e){
            dojo.query(&#x27;#pundit-ctp-more-tags&#x27;).addClass(&#x27;pundit-panel-loading&#x27;);
            if (e.target.value === &#x27;&#x27;){
                self.itemsDnD.selectAll();
                self.itemsDnD.deleteSelectedNodes();
                dojo.query(&#x27;#pundit-ctp-more-tags&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
            }
                
            if (typeof(self.lastTagRequest) !== &#x27;undefined&#x27;)
                self.lastTagRequest.cancel();
                
            dojo.destroy(dojo.query(&quot;.pundit-lookup-error&quot;)[0]);
            self.lastTagRequest = semlibDbpediaSpotlight.getDbpediaName(e.target.value);
        });

        dojo.behavior.add({
            &#x27;#pundit-ctp-tag-list li.dojoDndItem&#x27;:{
                &#x27;onmouseover&#x27;:function(e){
                    var node,
                        nodeUri,
                        id;
                    &#x2F;&#x2F;self.deselectAllItems();
                    dojo.hasClass(dojo.query(e.target)[0], &#x27;dojoDndItem&#x27;) ? id = e.target.id : id = dojo.query(e.target).parent()[0].id;
                    nodeUri = self.tagsDnD.getItem(id).data.value;                    
                    self.tagListItemSelected = true;
                    &#x2F;&#x2F;previewer.selectAndPreviewItemWithId(id, nodeUri, &#x27;#pundit-ctp-tag-preview&#x27;);
                    previewer.show(nodeUri, &#x27;#pundit-ctp-tag-preview&#x27;);
                    dojo.addClass(dojo.byId(id), &#x27;pundit-item-selected&#x27;);
                    dojo.query(&#x27;#pundit-ctp-comment-input a[about=&quot;&#x27; + nodeUri + &#x27;&quot;]&#x27;).forEach(function(node,i){
                        dojo.addClass(node, &#x27;pundit-selected&#x27;);
                    });
                    self.showPreview();
                },
                &#x27;onmouseout&#x27;: function(e) {
                    var node,
                        nodeUri;
                    
                    if (e.target.nodeName === &#x27;LI&#x27;){
                        node = dojo.query(e.target);
                    }else{
                        node = dojo.query(dojo.query(e.target).parent()[0]);
                    }
                    
                    &#x2F;&#x2F;dojo.query(&#x27;#pundit-ctp-tag-list li&#x27;).removeClass(&#x27;dojoDndItemAnchor&#x27;);
                    nodeUri = self.tagsDnD.getItem(node[0].id).data.value;
                    dojo.query(&#x27;#pundit-ctp-comment-input a[about=&quot;&#x27; + nodeUri + &#x27;&quot;]&#x27;).forEach(function(node,i){
                        dojo.removeClass(node, &#x27;pundit-selected&#x27;);
                    });
                }
            },
            &#x27;#pundit-ctp-comment-input a&#x27;:{
                &#x27;onmouseover&#x27;:function(e){
                    var uri = dojo.attr(e.target, &#x27;about&#x27;),
                        id = &#x27;&#x27;;
                    
                    &#x2F;&#x2F;self.deselectAllItems();
                    
                    &#x2F;&#x2F;Select the corresponding tagnode (there will be just one)
                    previewer.show(uri,&#x27;#pundit-ctp-tag-preview&#x27;);
                    self.showPreview();
                    for (var i in self.tagsDnD.map){
                        if (self.tagsDnD.map[i].data.value === uri){
                            dojo.addClass(i,&#x27;pundit-item-selected&#x27;);
                        }
                    }
                }
            },
            &#x27;#pundit-ctp-tag-list li.dojoDndItem span.pundit-icon-context-button&#x27;:{
                &#x27;onclick&#x27;:function(e){
                    var node = dojo.query(dojo.query(e.target).parent()[0]),
                    uri = self.tagsDnD.getItem(node[0].id).data.value;
                    cMenu.show(e.pageX - window.pageXOffset, e.pageY - window.pageYOffset, uri,&#x27;tagitem&#x27;);
                }
            },
            &#x27;#pundit-ctp-tag-list li.dojoDndItem span.pundit-item-remove-button&#x27;:{
                &#x27;onclick&#x27;:function(e) {
                    var node = dojo.query(dojo.query(e.target).parent()[0]),
                    uri = self.tagsDnD.getItem(node[0].id).data.value,
                    result = self.removeTagItem(uri);
                    
                    if (result)
                        &#x2F;&#x2F;previewer.deselectCurrentSelectedItem(&#x27;#pundit-ctp-tag-preview&#x27;)
                    
                    return result;
                }
            },
            &#x27;#pundit-ctp-more-tags-list li.dojoDndItem span.pundit-icon-context-button&#x27;:{
                &#x27;onclick&#x27;:function(e){
                    var node = dojo.query(dojo.query(e.target).parent()[0]),
                    uri = self.itemsDnD.getItem(node[0].id).data.value;
                    cMenu.show(e.pageX - window.pageXOffset, e.pageY - window.pageYOffset, uri,&#x27;suggestedtagitem&#x27;);
                }
            },
            &#x27;#pundit-ctp-more-tags-list li.dojoDndItem span.pundit-item-add-button&#x27;: {
                &#x27;onclick&#x27;:function(e) {
                    var node = dojo.query(dojo.query(e.target).parent()[0]),
                    uri = self.itemsDnD.getItem(node[0].id).data.value;
                    return self.addTagItem(uri);
                }
            },
            &#x27;#pundit-ctp-more-tags-list li.dojoDndItem&#x27;: {
                &#x27;onmouseover&#x27;: function (e) {
                    var item,
                        id;
                    dojo.hasClass(dojo.query(e.target)[0], &#x27;dojoDndItem&#x27;) ? id = e.target.id : id = dojo.query(e.target).parent()[0].id;    
                    item = self.itemsDnD.getItem(id);
                    dojo.addClass(dojo.byId(id), &#x27;pundit-item-selected&#x27;);
                    if (!item.data.value) {
                        previewer.setLoading(true,&#x27;#pundit-ctp-tag-preview&#x27;);
                    } else
                        previewer.show(item.data.value, &#x27;#pundit-ctp-tag-preview&#x27;);
        
                    self.tagListItemSelected = false;
                    self.showPreview();
                },
                &#x2F;&#x2F;MULTIPLOP Force the selection of the clicked node to avoid multiple drag
                &#x27;onclick&#x27;:function(e) {
                    var target = e.target;
                    while (!dojo.hasClass(dojo.query(target)[0], &#x27;dojoDndItem&#x27;))
                        target = dojo.query(target).parent()[0];
                    var id = target.id;
                    self.itemsDnD.selectNone();
                    self.itemsDnD.selection[id] = 1;
                }
            }
        });
        
    },

    &#x2F;**
    * @method itemIndex
    * @description Return the index of the Tag item in the tagItem array container
    * given its uri or -1 if no tag item has such index.
    * @param uri {string} 
    * @return {integer}
    * 
    *&#x2F;
    itemIndex: function(uri){
        var self = this;
        for (var i= self.tagItems.length -1; i&gt;=0; i--){
            if (self.tagItems[i].uri === uri)
                return i;
        }
        return -1;
    },
    
    showMarkedText: function(tags){
        var self = this,
            text = self.lastSearchedComment,
            a,
            reg;
        if (text === &#x27;&#x27;) return;

        for (var i in tags) {
            a = &#x27;&lt;a about=&quot;&#x27; + tags[i].uri + &#x27;&quot; href=&quot;&#x27; + tags[i].uri + &#x27;&quot; target=&quot;_blank&quot;&gt;&#x27; + tags[i].surfaceForm + &#x27;&lt;&#x2F;a&gt;&#x27;;
            &#x2F;&#x2F;Markup all the occurrence of a tag
            reg = new RegExp(tags[i].surfaceForm, &#x27;g&#x27;)
            text = text.replace(reg, a);
        }
        dojo.html.set(&#x27;pundit-ctp-comment-input&#x27;, text);
    },
    
    addSuggestedTags: function(tags){
        var self = this;
            self.lastTagInfoRequests = [];
            
        for (var i= tags.length -1; i&gt;=0; i--) 
            if (self.itemIndex(tags[i].uri) === -1) {
                self.tagItems.push(tags[i]);
                dojo.behavior.apply();
                self.lastTagInfoRequests.push(semlibDbpediaSpotlight.getInfoFromDBpedia(tags[i].uri));
            }
    },

    addItems: function(itemsData){
        var self = this;
        for (var i in itemsData){
            if (!self.uriInItems(itemsData[i].value))
                self.tagsDnD.insertNodes(false, [itemsData[i]]);
        }
        self.updateSaveBtn();
    },
    
    addTagItem: function(uri) {
        var self = this;
        self.itemsDnD.forInItems(function(item){
            if (item.data.value === uri){
                &#x2F;&#x2F;self.tagsDnD.insertNodes(false, [item.data]);
                self.addItems([item.data]);
                return;
            }
        });
        self.itemsDnD.deleteSelectedNodes();
        dojo.behavior.apply();
        return true;	
    },

    removeTagItem:function(uri) {
        var self = this;
        self.tagsDnD.deleteSelectedNodes();
        dojo.behavior.apply();
        self.removeItemFromUri(uri);
        &#x2F;&#x2F;self.hidePreview();
        self.updateMarkup();
        self.updateSaveBtn();
        return true;
    },
    
    updateMarkup:function(){
        var self = this;
        self.showMarkedText(self.tagItems);
    },

    uriInItems:function(uri){
        var self = this,
            inItems = false;
        
        self.tagsDnD.forInItems(function(item){
            if (item.data.value === uri){
                inItems = true;
                return;
            }   
        });
        return inItems;
    },
    
    &#x2F;**
    * @method removeItemFromUri
    * @description Remove a tag item from the tagItems array and from the tag 
    * container given its uri
    * @param uri {string} 
    * @return {void}
    *&#x2F;
    removeItemFromUri:function(uri){
        var self = this,
        index = this.itemIndex(uri);

        if (index !== -1)
            self.tagItems.splice(index,1);
        dojo.destroy(dojo.query(&#x27;#pundit-ctp-tag-list li[about=&#x27; + uri + &#x27;]&#x27;)[0]);
    },
    
    &#x2F;**
    * @method removeLinkFromUri
    * @description Remove an hyperlink from the marked up text given its uri
    * @param uri {string} 
    * @return {void}
    *&#x2F;
    removeLinkFromUri:function(uri){
        dojo.query(&#x27;#pundit-ctp-comment-input a[about=&quot;&#x27; + uri + &#x27;&quot;]&#x27;).forEach(function(node){
            &#x2F;&#x2F;dojo.place(&#x27;&lt;span&gt;&#x27; + node.innerHTML + &#x27;&lt;&#x2F;span&gt;&#x27;, node, &#x27;replace&#x27;);
            dojo.place(&#x27;&lt;span&gt;&#x27; + node.innerHTML + &#x27;&lt;&#x2F;span&gt;&#x27;, node, &#x27;replace&#x27;);
        })
    },
    
    addTagToContainer:function(uri){
        li = &#x27;&lt;li about=&quot;&#x27; + uri + &#x27;&quot; class=&quot;tagItem pundit-object pundit-shown loading&quot;&gt;&lt;span class=&quot;pundit-icon-context-button&quot;&gt;&lt;&#x2F;span&gt;&#x27; + decodeURIComponent(uri.substring(uri.lastIndexOf(&#x27;&#x2F;&#x27;) +1).replace(&#x2F;_&#x2F;g, &#x27; &#x27;)) + &#x27;&lt;&#x2F;li&gt;&#x27;;
        dojo.query(&#x27;#pundit-ctp-tag-list&#x27;).append(li);
    },

    addTagInfo: function(info) {
        var self = this;
        &#x2F;&#x2F;DEBUG
        &#x2F;&#x2F;Should i add a flag to see if info has been already added or use the loading class
        var index = self.itemIndex(info.uri);
        
        if (index !== -1) {
            var i = info.data.bindings[0];
            self.tagItems[index].description = i.comment.value;
            self.tagItems[index].label = i.label.value;
            if (typeof(i.depiction) !== &#x27;undefined&#x27;)
                self.tagItems[index].image = i.depiction.value;

            dojo.query(&#x27;#pundit-ctp-tag-list li[about=&#x27; + info.uri + &#x27;]&#x27;).removeClass(&#x27;loading&#x27;);
        }
    },
    
    showPreviewByUri: function(uri){
        var self = this,
            node = dojo.query(&#x27;#pundit-ctp-tag-list li[about=&quot;&#x27; + uri + &#x27;&quot;]&#x27;)[0],
            img;
        dojo.empty(&#x27;pundit-ctp-tag-preview&#x27;);
        if (typeof(uri) !== &#x27;undefined&#x27;){
            if (dojo.hasClass(node, &#x27;loading&#x27;)){
                dojo.query(&#x27;#pundit-ctp-tag-preview&#x27;).addClass(&#x27;pundit-panel-loading&#x27;);
            } else {
                var item = self.tagItems[self.itemIndex(uri)];
                if (typeof(item.image) !== &#x27;undefined&#x27;)
                    img = &#x27;&lt;img src=&quot;&#x27; + item.image + &#x27;&quot;&gt;&lt;&#x2F;img&gt;&#x27;;

                var html = &#x27;&lt;span&gt;&#x27; + img + item.description + &#x27;&lt;&#x2F;span&gt;&#x27;;
                dojo.html.set(&#x27;pundit-ctp-tag-preview&#x27;, html);
                dojo.query(&#x27;#pundit-ctp-tag-preview&#x27;).removeClass(&#x27;pundit-panel-loading&#x27;);
            }
        }
    },

	&#x2F;**
	* @method addHyperlinksToText
    * @description Searches for http urls in the text and turns them into HTML hyperlinks.
    * @param text {string} 
    * @return {string}
	*&#x2F;    
	addHyperlinksToText: function(text) {
	    var exp = &#x2F;(\b(https?|ftp|file):\&#x2F;\&#x2F;[-A-Z0-9+&amp;@#\&#x2F;%?=~_|!:,.;]*[-A-Z0-9+&amp;@#\&#x2F;%=~_|])&#x2F;i;
	    return text.replace(exp,&quot;&lt;a href=&#x27;$1&#x27;&gt;$1&lt;&#x2F;a&gt;&quot;); 
	},

	&#x2F;**
	* @method parseInputText
    * @description Parses the input types by user and performs text transformations, e.g. to escape unpermitted tags.
    * @param text {string} 
    * @return {string}
	*&#x2F;
	parseInputText: function(text) {
		return unescape(text.innerHTML.replace(&#x2F;&amp;nbsp;&#x2F;g,&#x27; &#x27;));
	},

    saveTriples: function(){
        var self = this;
        var annotationPageContext = window.location.href,
            &#x2F;&#x2F;comment = unescape(dojo.byId(&#x27;pundit-ctp-comment-input&#x27;).innerHTML.replace(&#x2F;&lt;(?:.|\n)*?&gt;&#x2F;gm, &#x27;&#x27;).replace(&#x2F;&amp;nbsp;&#x2F;g,&#x27; &#x27;));
            comment = self.parseInputText(dojo.byId(&#x27;pundit-ctp-comment-input&#x27;)),
            b = new pundit.TriplesBucket();
        dojo.attr(dojo.byId(&quot;pundit-ctp-save&quot;), &#x27;disabled&#x27;, true);
        &#x2F;&#x2F; Comment triples
        if (comment !== &#x27;&#x27;)
            for (var i in self.targets)
                b.addTriple(self.targets[i], ns.pundit_hasComment, comment, &#x27;literal&#x27;);
        
        &#x2F;&#x2F; Tags triples
        for (var j in self.tagsDnD.map){
            var item = self.tagsDnD.map[j];
            for (var k in self.targets){
                b.addTriple(self.targets[k], ns.pundit_hasTag, item.data.value, &#x27;uri&#x27;);
            }
        }
        
        tooltip_viewer.removeHighlightByXpointer(self.xpTarget);
        tooltip_viewer.removeTempXpointer(self.xpTarget);

        if (!b.isEmpty()) {
	        self.log(&#x27;Saving triples json: &#x27; + dojo.toJson(b.getTalisJson()));
            self.saver.writeAnnotationContent(b, self.targets, annotationPageContext);
		} else {
		    self.log(&#x27;Empty bucket in saveTriples??!&#x27;);
		}
        
    }, &#x2F;&#x2F; saveTriples()
    
    saveItems: function(annotationID){
        var self = this,
        annotationPageContext = window.location.href,
        b = new pundit.TriplesBucket();
  
        self.log(&#x27;Saving items for annotation &#x27;+annotationID);
       
        &#x2F;&#x2F; Target Metadata
        for (var i in self.targets) {
            var xp = self.targets[i], 
            item;

            &#x2F;&#x2F;FIX ME: Triples are already in the item rdfData field. Why recreate them?!?!?!
            if (xp.indexOf(&#x27;#xpointer&#x27;) !== -1) {
                
            
                &#x2F;&#x2F; Use it if it is a known item, else it&#x27;s not an item yet,
                &#x2F;&#x2F; create one and save it
                &#x2F;&#x2F; TODO: x marco usare il nuovo coso globale per trovare l&#x27;item?
                item = _PUNDIT.items.getItemByUri(xp);
                if (typeof item === &#x27;undefined&#x27;)
                    item = fragmentHandler.createItemFromXpointer(xp);
                
				b.addTriple(xp, ns.rdf_type, item.rdftype[0], &#x27;uri&#x27;);

                &#x2F;&#x2F; fragmentHandler.createItemFromXpointer(self.targets[i]);
                &#x2F;&#x2F; var titem = semlibItems.getItemFromUri(self.targets[i]);

                b.addTriple(xp, ns.items.label, item.label, &#x27;literal&#x27;);
                b.addTriple(xp, ns.items.altLabel, item.label, &#x27;literal&#x27;);
                b.addTriple(xp, ns.items.description, item.description, &#x27;literal&#x27;);
  
                &#x2F;&#x2F; DEBUG: x marco ma quand&#x27;e&#x27; che c&#x27;ha depiction? Quando parte il comment
                &#x2F;&#x2F; tag per una immagine? Dov&#x27;e&#x27; il cmenu? Se ho rotto qualcosa parliamone,
                &#x2F;&#x2F; magari spostiamo la creazione di sto item in self.commentingItem, cosi&#x27; 
                &#x2F;&#x2F; lo crei dalla onClick del cMenu e qui lo usiamo e basta
                if (typeof(item.image) !== &#x27;undefined&#x27;)
                    b.addTriple(xp, ns.items.image, item.image, &#x27;uri&#x27;);

                b.addTriple(xp, ns.items.pageContext, item.pageContext, &#x27;uri&#x27;);
                b.addTriple(xp, ns.items.isPartOf, item.isPartOf, &#x27;uri&#x27;);

            &#x2F;&#x2F;b.addTriple(titem.value, ns.items.type, ns.fragments.text, &#x27;uri&#x27;);
            &#x2F;&#x2F;b.addTriple(ns.fragments.text, ns.items.label, &#x27;Page fragment&#x27;, &#x27;literal&#x27;);

            &#x2F;&#x2F;DEBUG this should be added by inference? It is not.
            } else {
                b.addTriple(xp, ns.rdf_type, ns.page, &#x27;uri&#x27;);
            &#x2F;&#x2F;DEBUG!
            &#x2F;&#x2F;This should never happen at the moment
            &#x2F;&#x2F;But if we want to add annotation to the page what metadata should we add
            }
        } &#x2F;&#x2F; for i in self.targets
        
        &#x2F;&#x2F; tags metadata
        for (var j in self.tagsDnD.map) {
            var item = self.tagsDnD.map[j];
            
            var rd = item.data.rdfData;
            for (i in rd){
                b.addTriple(rd[i].s, rd[i].p, rd[i].o, rd[i].otype);
            }
        }
            
        &#x2F;&#x2F;Resource metadata for fragment
        b.addTriple(ns.fragments.text, ns.rdfs_label, &#x27;Page fragment&#x27;, &#x27;literal&#x27;);
        b.addTriple(ns.page, ns.rdfs_label, &#x27;Page&#x27;, &#x27;literal&#x27;);

        &#x2F;&#x2F;Property Metadata
        b.addTriple(ns.pundit_hasComment, ns.rdf_type, ns.rdf_property, &#x27;uri&#x27;);
        b.addTriple(ns.pundit_hasComment, ns.rdfs_label, &#x27;has comment&#x27;, &#x27;literal&#x27;);
        b.addTriple(ns.pundit_hasTag, ns.rdf_type, ns.rdf_property, &#x27;uri&#x27;);
        b.addTriple(ns.pundit_hasTag, ns.rdfs_label, &#x27;has tag&#x27;, &#x27;literal&#x27;);

        if (!b.isEmpty()) {
            self.log(&#x27;Posting &#x27;+b.bucket.length+&#x27; item triples..&#x27;);
            self.saver.writeAnnotationItems(annotationID, dojo.toJson(b.getTalisJson()));
        } else {
            self.log(&#x27;saveItems with an empty bucket??!&#x27;);
        }
        
        self.tagItems = [];
    }, &#x2F;&#x2F; saveItems()
    
    updateSaveBtn:function(){
        var self = this;
        if ((dojo.byId(&#x27;pundit-ctp-comment-input&#x27;).innerHTML.replace(&#x2F;&lt;(?:.|\n)*?&gt;&#x2F;gm, &#x27;&#x27;) === &#x27;&#x27;) &amp;&amp; (self.tagsDnD.getAllNodes().length === 0))
            dojo.attr(dojo.byId(&quot;pundit-ctp-save&quot;), &#x27;disabled&#x27;, true);
        else
            dojo.attr(dojo.byId(&quot;pundit-ctp-save&quot;), &#x27;disabled&#x27;, false);
    },
    cancelPendingRequests: function(){
        var self = this;
        
        self.cancelPendingSpotlightRequests();

        if (typeof(self.lastTagRequest) !== &#x27;undefined&#x27;)
                self.lastTagRequest.cancel();
    },
    cancelPendingSpotlightRequests: function(){
        var self = this;
        if (typeof(self.enableSemanticExpansion) !== &quot;undefined&quot;) 
            self.enableSemanticExpansion.cancel();
        
        
        if (self.lastTagInfoRequests.length &gt; 0)
            for (i in self.lastTagInfoRequests)
                self.lastTagInfoRequests[i].cancel();
    },
    close: function(){
        var self = this;
        self.cancelPendingRequests();
        dojo.style(&#x27;pundit-ctp&#x27;, &#x27;opacity&#x27;, 0);
        &#x2F;&#x2F;Destroy the container once the animation has completed
        setTimeout(function(){dojo.destroy(dojo.byId(&#x27;pundit-ctp&#x27;));},1000); 
        &#x2F;&#x2F; On close, remove the highlight, and avoid an opening highlight
        &#x2F;&#x2F; on next consolidate
        tooltip_viewer.removeHighlightByXpointer(self.xpTarget);
        &#x2F;&#x2F;Remove the xpointer from the tempXpointers
        tooltip_viewer.removeTempXpointer(self.xpTarget);
        self.opening = false;

        &#x2F;&#x2F;Refresh annotation in any case
        tooltip_viewer.refreshAnnotations();
        self.targets = [];
    },
    show: function(){
        dojo.style(&#x27;pundit-ctp&#x27;, &#x27;opacity&#x27;,1);
        dijit.focus(dojo.byId(&#x27;pundit-ctp-comment-input&#x27;));
    },
    deselectAllItems:function(){
        dojo.query(&quot;#pundit-ctp li.dojoDndItem&quot;).forEach(function(node){dojo.removeClass(node,&#x27;pundit-item-selected&#x27;);})
    },
    hidePreview:function(){
        dojo.removeClass(&#x27;pundit-ctp-content-list&#x27;, &#x27;pundit-preview&#x27;);
    },
    showPreview:function(){
        var self = this;
        self.deselectAllItems();
        dojo.addClass(&#x27;pundit-ctp-content-list&#x27;, &#x27;pundit-preview&#x27;);
    }
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
