<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src&#x2F;AuthenticatedRequests.js - Pundit</title>
    <link rel="stylesheet" href="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;3.8.0pr2&#x2F;build&#x2F;cssgrids&#x2F;cssgrids-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="..&#x2F;assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="..&#x2F;assets/favicon.png">
    <script src="http:&#x2F;&#x2F;yui.yahooapis.com&#x2F;combo?3.8.0pr2&#x2F;build&#x2F;yui&#x2F;yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="http:&#x2F;&#x2F;thepund.it&#x2F;assets&#x2F;img&#x2F;pundit_500.png" title="Pundit"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: PUNDIT Project 0.12-Pumpkin</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="..&#x2F;classes/pundit.annotators.AnnotatorsBase.html">pundit.annotators.AnnotatorsBase</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.AnnotatorsConductor.html">pundit.annotators.AnnotatorsConductor</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.FakeAnnotator.html">pundit.annotators.FakeAnnotator</a></li>
            
                <li><a href="..&#x2F;classes/pundit.annotators.TextFragmentAnnotator.html">pundit.annotators.TextFragmentAnnotator</a></li>
            
                <li><a href="..&#x2F;classes/pundit.authenticatedRequests.html">pundit.authenticatedRequests</a></li>
            
                <li><a href="..&#x2F;classes/pundit.baseComponent.html">pundit.baseComponent</a></li>
            
                <li><a href="..&#x2F;classes/pundit.BasePanel.html">pundit.BasePanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.CommentTag.html">pundit.CommentTag</a></li>
            
                <li><a href="..&#x2F;classes/pundit.CommentTagPanel.html">pundit.CommentTagPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Configuration.html">pundit.Configuration</a></li>
            
                <li><a href="..&#x2F;classes/pundit.contextualMenu.html">pundit.contextualMenu</a></li>
            
                <li><a href="..&#x2F;classes/pundit.DataTxt.html">pundit.DataTxt</a></li>
            
                <li><a href="..&#x2F;classes/pundit.DbpediaSpotlight.html">pundit.DbpediaSpotlight</a></li>
            
                <li><a href="..&#x2F;classes/pundit.FastTextHandler.html">pundit.FastTextHandler</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ImageAnnotationPanel.html">pundit.ImageAnnotationPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Init.html">pundit.Init</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ItemContainerManager.html">pundit.ItemContainerManager</a></li>
            
                <li><a href="..&#x2F;classes/pundit.KorboBasketSelector.html">pundit.KorboBasketSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.myPundit.html">pundit.myPundit</a></li>
            
                <li><a href="..&#x2F;classes/pundit.NotebookManager.html">pundit.NotebookManager</a></li>
            
                <li><a href="..&#x2F;classes/pundit.PageHandler.html">pundit.PageHandler</a></li>
            
                <li><a href="..&#x2F;classes/pundit.Previewer.html">pundit.Previewer</a></li>
            
                <li><a href="..&#x2F;classes/pundit.RecognizerPanel.html">pundit.RecognizerPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.ResourcesPanel.html">pundit.ResourcesPanel</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.BibServerSelector.html">pundit.selectors.BibServerSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.DBPediaSelector.html">pundit.selectors.DBPediaSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.EuropeanaSelector.html">pundit.selectors.EuropeanaSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.FreebaseSelector.html">pundit.selectors.FreebaseSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.SelectorBase.html">pundit.selectors.SelectorBase</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.VocabSelector.html">pundit.selectors.VocabSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.selectors.WordnetSelector.html">pundit.selectors.WordnetSelector</a></li>
            
                <li><a href="..&#x2F;classes/pundit.TripleComposer.html">pundit.TripleComposer</a></li>
            
                <li><a href="..&#x2F;classes/pundit.XpointersHelper.html">pundit.XpointersHelper</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="..&#x2F;modules/pundit.html">pundit</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src&#x2F;AuthenticatedRequests.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x2F;**
    Provides facilities to interact with the pundit server, through
    authenticated API Calls. The authentication is granted by an OpenID workflow,
    initialized here and carried on by the server. When logged in, this component
    notifies the user and executes any previously blocked request, which needed
    authentication to work.
    @class pundit.authenticatedRequests
    @constructor
    @extends pundit.baseComponent
    @module pundit
    @example
        var x = new pundit.AuthenticatedRequests({
                loginAutomaticHideMS: 100
            });
    @param options {object} See object properties
**&#x2F;
dojo.provide(&quot;pundit.AuthenticatedRequests&quot;);
dojo.declare(&quot;pundit.AuthenticatedRequests&quot;, pundit.BaseComponent, {

    opts : {
        &#x2F;**
            Timer used to poll the server to trigger the login done event
            @property loginTimerMS
            @type Integer (milliseconds)
            @default 500 
        **&#x2F;
        loginTimerMS: 500,
        &#x2F;**
            Hide the login window after these many milliseconds
            @property loginAutomaticHideMS
            @type Integer (milliseconds)
            @default 2000 
        **&#x2F;
        loginAutomaticHideMS: 2000
    },

    blockedRequests: [],

    constructor: function(options) {
        var self = this;
        
        self.redirectURL = null;
        self.initLoginDialog();
    
        &#x2F;**
            Called when the user succesfully completes the OpenID 
            authentication workflow.
            @event onLogin
            @param f(data) {function} function to be called.&lt;br&gt;
                data is the json object coming from the server on succesfull login. 
        *&#x2F;

	    &#x2F;**
            Called when the user succesfully logs out.
            @event onLogout
            @param f(data) {function} function to be called.&lt;br&gt;
                data is the json object coming from the server on succesfull logout. 
        *&#x2F;
        self.createCallback([&#x27;login&#x27;, &#x27;logout&#x27;]);
        
        self.log(&#x27;Authenticated requests component up and running!&#x27;);
    },

    initLoginDialog: function() {
        var self = this,
        h = &quot;&lt;div id=&#x27;pundit-login-popup-content&#x27; class=&#x27;off tundra&#x27;&gt;&quot;;

        h += &quot;&lt;div class=&#x27;off&#x27;&gt;&lt;p&gt;To view annotations on this page you must log in.&lt;&#x2F;p&gt;&lt;&#x2F;div&gt;&quot;;
        h += &quot;&lt;div class=&#x27;waiting&#x27;&gt;&lt;p&gt;Please complete the process in the login window&lt;&#x2F;p&gt;&lt;&#x2F;div&gt;&quot;;
        h += &quot;&lt;div class=&#x27;logged&#x27;&gt;&lt;p&gt;You are logged in as:&lt;&#x2F;p&gt; &lt;span class=&#x27;username&#x27;&gt;XYZ&lt;&#x2F;span&gt;&lt;&#x2F;div&gt;&quot;;

        h += &quot;&lt;div id=&#x27;pundit-login-popup-buttons&#x27;&gt;&quot;;
        h += &quot;&lt;span id=&#x27;pundit-login-close-button&#x27;&gt;Close&lt;&#x2F;span&gt;&quot;;
        h += &quot;&lt;span id=&#x27;pundit-login-open-button&#x27;&gt;Open the login window&lt;&#x2F;span&gt;&quot;;

        h += &quot;&lt;&#x2F;div&gt;&quot;;
        h += &quot;&lt;&#x2F;div&gt;&quot;;
		
        self.dialog = new dijit.Dialog({
            style: &quot;width: 400px&quot;
        });
        dojo.addClass(dojo.byId(self.dialog.id), &#x27;tundra&#x27;);
        &#x2F;&#x2F; Emulating closable: false. Thanks dojo! ;)
        dojo.destroy(self.dialog.closeButtonNode);

        self.dialog.attr(&quot;content&quot;, h);
        dojo.connect(dojo.byId(&#x27;pundit-login-open-button&#x27;), &#x27;onclick&#x27;, function() {
            self.openLoginPopUp();
        });
        dojo.connect(dojo.byId(&#x27;pundit-login-close-button&#x27;), &#x27;onclick&#x27;, function() { 
            self.dialog.hide();
            clearTimeout(self.loginTimer);
        });
	    
    },
	
    &#x2F;**
    * @method xGet
    * @description Performs an HTTP get through an authenticated Ajax call.
    * @param options {object} the same object one would pass to a 
    * normal dojo xhrGet().
    *&#x2F;
    xGet: function(callParams) {
        return dojo.xhrGet(this.setWrappingCallParams(callParams));	
    },
	
    &#x2F;**
    * @method xPost
    * @description Performs an HTTP post through an authenticated Ajax call.
    * @param options {object} the same object one would pass to a 
    * normal dojo xhrPost().
    *&#x2F;
    xPost: function(callParams) {
        dojo.xhrPost(this.setWrappingCallParams(callParams));
    },
	
    &#x2F;**
    * @method xPut
    * @description Performs an HTTP put through an authenticated Ajax call.
    * @param options {object} the same object one would pass to a 
    * normal dojo xhrPut().
    *&#x2F;
    xPut: function(callParams) {
        dojo.xhrPut(this.setWrappingCallParams(callParams));
    },
	
    &#x2F;**
    * @method xDelete
    * @description Performs an HTTP delete through an authenticated Ajax call.
    * @param options {object} the same object one would pass to a 
    * normal dojo xhrDelete().
    *&#x2F;
    xDelete: function(callParams) {
        dojo.xhrDelete(this.setWrappingCallParams(callParams));
    },
	
    showLoginForm: function(redirectURL) {
        this.redirectURL = redirectURL;
        this.dialog.attr(&quot;title&quot;, &#x27;You are not logged in!&#x27;);
        dojo.query(&#x27;#pundit-login-popup-content&#x27;).removeClass(&#x27;logged&#x27;).removeClass(&#x27;waiting&#x27;);
        this.dialog.show();
    },
	
    openLoginPopUp : function() {
        var self = this;
		    
        window.open(self.redirectURL, &#x27;loginpopup&#x27;, &#x27;left=260,top=120,width=480,height=360&#x27;);

        dojo.query(&#x27;#pundit-login-popup-content&#x27;).removeClass(&#x27;off&#x27;).addClass(&#x27;waiting&#x27;);
        self.loginTimer = setTimeout(function() {
            self.checkLogin();
        }, self.opts.loginTimerMS);

    },

    checkLogin: function(f) {
        var self = this;
        
        var args = {
            url: ns.annotationServerUsersCurrent,
            handleAs: &quot;json&quot;,
            headers: {
                &quot;Accept&quot;:&quot;application&#x2F;json&quot;
            },
            load: function(data) {
                if (typeof(data) === &#x27;undefined&#x27; || typeof(data.loginStatus) === &#x27;undefined&#x27;) { 
                    data = {
                        loginStatus: 0
                    };
                }
                
                if (typeof(f) === &#x27;function&#x27;) {
                    f(data);
                    return;
                } else if (data.loginStatus == 0) {
                    self.log(&#x27;Not logged in.. yet...&#x27;);
                    self.loginTimer = setTimeout(function() {
                        self.checkLogin();
                    }, self.opts.loginTimerMS);
                    return;
                }
                self.login(data);
            },
            error: function(error) {}
        }

        self.xGet(args);
    }, &#x2F;&#x2F; checkLogin()
    
    login: function(data) {
        var self = this;
        
        self.dialog.attr(&quot;title&quot;, &#x27;You are now logged in!!&#x27;);
        dojo.query(&#x27;#pundit-login-popup-content span.username&#x27;).html(data.fullName+&quot; (&quot;+data.email+&quot;)&quot;);
        dojo.query(&#x27;#pundit-login-popup-content&#x27;).removeClass(&#x27;waiting&#x27;).addClass(&#x27;logged&#x27;);
        
        &#x2F;&#x2F;for (var i in self.blockedRequests) 
        for (var i = self.blockedRequests.length; i--;) 
            self.xGet(self.blockedRequests[i]);
      
        self.fireOnLogin(data);
        
        setTimeout(function() { 
            self.dialog.hide();
        }, self.opts.loginAutomaticHideMS);
        
    },
    
    logout: function(f) {
        var self = this;
        
        clearTimeout(self.loginTimer);
        
        var args = {
            url: ns.annotationServerUsersLogout,
            handleAs: &quot;json&quot;,
            headers: {
                &quot;Accept&quot;:&quot;application&#x2F;json&quot;
            },
            load: function(data) {
                var msg;
                if (typeof(data) !== &#x27;undefined&#x27; &amp;&amp; typeof(data.logout) !== &#x27;undefined&#x27;) {
                    data.msg = (data.logout == 1) ? &#x27;Logged out succesfully&#x27; : &#x27;You werent logged in.. and you still arent.&#x27;;

                    if (typeof(f) === &#x27;function&#x27;)
                        f(data);

                    self.fireOnLogout(data);
                }
            },
            error: function(error) {}
        }

        self.xGet(args);
    },
	
    setWrappingCallParams : function(originalCallParams) {
        var self = this,
            wrappedParams = {
                &#x27;withCredentials&#x27;: true
            },
            key;
		    
        for (key in originalCallParams) 
            if (key !== &quot;load&quot;) 
                wrappedParams[key] = originalCallParams[key];
            else 
                wrappedParams[key] = function(r) {
                    if (r &amp;&amp; typeof(r.redirectTo) !== &quot;undefined&quot;) {
                        self.blockedRequests.push(wrappedParams);
                        self.showLoginForm(r.redirectTo);
                    } else 
                        originalCallParams.load(r);
                }
				
        return wrappedParams;
    }		
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="..&#x2F;assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="..&#x2F;assets/js/yui-prettify.js"></script>
<script src="..&#x2F;assets/../api.js"></script>
<script src="..&#x2F;assets/js/api-filter.js"></script>
<script src="..&#x2F;assets/js/api-list.js"></script>
<script src="..&#x2F;assets/js/api-search.js"></script>
<script src="..&#x2F;assets/js/apidocs.js"></script>
</body>
</html>
